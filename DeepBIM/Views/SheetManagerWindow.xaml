<Window x:Class="DeepBIM.Views.SheetManagerWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:sys="clr-namespace:System;assembly=mscorlib"
        xmlns:converters="clr-namespace:DeepBIM.Converters"
        mc:Ignorable="d"
        Width="1600" Height="805" WindowStartupLocation="CenterScreen"
        Title="DeepBIM - Change Sheet Name / Sheet Number"
        Icon="/DeepBIM;component/Resources/Icons/logo.png"
        >


    <!-- ================= THEME / STYLES ================= -->

    <Window.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="../Resources/Styles/Styles.xaml"/>
                <ResourceDictionary Source="../Resources/Styles/ComboboxStyle.xaml"/>
                <ResourceDictionary Source="../Resources/Styles/TextBlockStyle.xaml"/>
                <ResourceDictionary Source="../Resources/Styles/DataGridStyle.xaml"/>
            </ResourceDictionary.MergedDictionaries>

            <!-- Additional Styles -->
        </ResourceDictionary>
    </Window.Resources>

    <Grid Margin="10">
        <!-- Slightly increase left column, stretch button column for balance -->
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="340"/>
            <!-- Left -->
            <ColumnDefinition Width="64"/>
            <!-- Round button strip -->
            <ColumnDefinition Width="*"/>
            <!-- Table & bottom area -->
        </Grid.ColumnDefinitions>
        <Grid.RowDefinitions>
            <RowDefinition Height="*"/>
            <RowDefinition Height="250"/>
            <!-- Bottom config area slightly larger -->
        </Grid.RowDefinitions>

        <!-- LEFT: All sheets -->
        <Border Grid.RowSpan="1" Style="{StaticResource Card}" Margin="0 0 12 0">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <Border Style="{StaticResource HeaderBar}">
                    <TextBlock Text="All Sheets" Foreground="White" FontWeight="SemiBold"/>
                </Border>

                <TextBox Grid.Row="1" 
                         Style="{StaticResource WatermarkTextBox}"
                         Tag="🔎  Search Sheet. Press Enter to apply search."
                         Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                         KeyUp="SearchBox_KeyUp"
                         Margin="0,10,0,8"/>

                <Border Grid.Row="2" BorderBrush="{StaticResource CardBorder}" BorderThickness="1" CornerRadius="6" Padding="6">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <!-- Select all -->
                        <CheckBox Content=" - Select all Sheets - "
                                  IsChecked="{Binding SelectAll, Mode=TwoWay}"
                                  Margin="6 0 0 8"/>

                        <!-- List populated from ViewModel -->
                        <ListBox Grid.Row="1"
                                 ItemsSource="{Binding SheetsView}"
                                 BorderThickness="0">
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <DockPanel>
                                        <CheckBox IsChecked="{Binding IsChecked, Mode=TwoWay}" Margin="6 0"/>
                                        <TextBlock Text="{Binding Display}" VerticalAlignment="Center" Margin="6 0"/>
                                    </DockPanel>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                    </Grid>
                </Border>
            </Grid>
        </Border>

        <!-- MIDDLE: round buttons -->
        <StackPanel Grid.Column="1" Grid.Row="0" VerticalAlignment="Center">
            <Button Style="{StaticResource IconButton}"
                    Content="&#xE8C8;"
                    ToolTip="Copy current values to new column"
                    Command="{Binding DuplicateCommand}" />
            <!-- MoveToRightCommand -->
            <Button 
                    ToolTip="Move to processing list"
                    Command="{Binding MoveToRightCommand}"
                    Style="{StaticResource IconButton}" Content="&#xE110;" RenderTransformOrigin="0.5,0.5">
                <Button.RenderTransform>
                    <TransformGroup>
                        <ScaleTransform/>
                        <SkewTransform/>
                        <RotateTransform Angle="90"/>
                        <TranslateTransform/>
                    </TransformGroup>
                </Button.RenderTransform>
            </Button>

            <!-- MoveToLeftCommand -->
            <Button
                    Click="MoveToLeft_Click"
                    Style="{StaticResource IconButton}" Content="&#xE110;" ToolTip="Move left" RenderTransformOrigin="0.5,0.5">
                <Button.RenderTransform>
                    <TransformGroup>
                        <ScaleTransform/>
                        <SkewTransform/>
                        <RotateTransform Angle="-90"/>
                        <TranslateTransform/>
                    </TransformGroup>
                </Button.RenderTransform>
            </Button>

            <Button Click="MoveRowUp_Click" Style="{StaticResource IconButton}" Content="&#xE110;" ToolTip="Move up"/>
            <Button Click="MoveRowDown_Click" Style="{StaticResource IconButton}" Content="&#xE111;" ToolTip="Move down" VerticalAlignment="Bottom" RenderTransformOrigin="0.5,0.5">
                <Button.RenderTransform>
                    <TransformGroup>
                        <ScaleTransform/>
                        <SkewTransform/>
                        <RotateTransform Angle="90"/>
                        <TranslateTransform/>
                    </TransformGroup>
                </Button.RenderTransform>
            </Button>
            <Button Command="{Binding RefreshCommand}" Style="{StaticResource IconButton}" Content="&#xE72C;" ToolTip="Refresh list"/>

            <Button Style="{StaticResource IconButton}"
                    Content="&#xE74D;"
                    ToolTip="Delete selected rows"
                    Command="{Binding DeleteSelectedSheetsCommand}" />
        </StackPanel>

        <!-- RIGHT/TOP: grid -->
        <Border Grid.Column="2" Grid.Row="0" Style="{StaticResource Card}">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="500"/>
                </Grid.RowDefinitions>

                <!-- HEADER -->
                <Border Style="{StaticResource HeaderBar}">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <!-- Index -->
                            <ColumnDefinition Width="2*"/>
                            <!-- Current Number -->
                            <ColumnDefinition Width="2*"/>
                            <!-- New Number -->
                            <ColumnDefinition Width="3*"/>
                            <!-- Current Name -->
                            <ColumnDefinition Width="3*"/>
                            <!-- New Name -->
                        </Grid.ColumnDefinitions>

                        <TextBlock Grid.Column="0" Text="Index"
                                   Foreground="White" FontWeight="SemiBold"
                                   HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        <TextBlock Grid.Column="1" Text="Current Sheet Number"
                                   Foreground="White" FontWeight="SemiBold"
                                   HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        <TextBlock Grid.Column="2" Text="New Sheet Number"
                                   Foreground="White" FontWeight="SemiBold"
                                   HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        <TextBlock Grid.Column="3" Text="Current Sheet Name"
                                   Foreground="White" FontWeight="SemiBold"
                                   HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        <TextBlock Grid.Column="4" Text="New Sheet Name"
                                   Foreground="White" FontWeight="SemiBold"
                                   HorizontalAlignment="Center" VerticalAlignment="Center"/>
                    </Grid>
                </Border>

                <!-- DATAGRID -->
                <DataGrid x:Name="DataGridRows"
                          Grid.Row="1"
                          ItemsSource="{Binding Rows}"
                          AutoGenerateColumns="False"
                          HeadersVisibility="Row"
                          RowHeaderWidth="40"
                          LoadingRow="DataGridRows_LoadingRow">

                    <DataGrid.Columns>

                        <!-- Current Sheet Number -->
                        <DataGridTextColumn Binding="{Binding CurrentNumber}" Width="2*" IsReadOnly="True">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="VerticalAlignment" Value="Center"/>
                                    <Setter Property="Margin" Value="8,0,8,0"/>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>

                        <!-- New Sheet Number -->
                        <DataGridTemplateColumn Width="2*">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding NewNumber}" VerticalAlignment="Center" Margin="8,0,8,0"/>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                            <DataGridTemplateColumn.CellEditingTemplate>
                                <DataTemplate>
                                    <TextBox Style="{StaticResource UnderlineTextBox}"
                                             Text="{Binding NewNumber, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellEditingTemplate>
                        </DataGridTemplateColumn>

                        <!-- Current Sheet Name -->
                        <DataGridTextColumn Binding="{Binding CurrentName}" Width="3*" IsReadOnly="True">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="VerticalAlignment" Value="Center"/>
                                    <Setter Property="Margin" Value="8,0,8,0"/>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>

                        <!-- New Sheet Name -->
                        <DataGridTemplateColumn Width="3*">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding NewName}" VerticalAlignment="Center" Margin="8,0,8,0"/>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                            <DataGridTemplateColumn.CellEditingTemplate>
                                <DataTemplate>
                                    <TextBox Style="{StaticResource UnderlineTextBox}"
                                             Text="{Binding NewName, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellEditingTemplate>
                        </DataGridTemplateColumn>
                    </DataGrid.Columns>
                </DataGrid>
            </Grid>
        </Border>

        <!-- RIGHT/BOTTOM: config + actions -->
        <Grid Grid.Column="0" Grid.Row="1" Grid.ColumnSpan="3">
            <!-- Balanced ratio: 1.15 : 1.35 : 2.5 + fixed 280px actions column -->
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="1.1*" MinWidth="220"/>
                <!-- Scope -->
                <ColumnDefinition Width="1.3*" MinWidth="240"/>
                <!-- Sort -->
                <ColumnDefinition Width="2.6*" MinWidth="420"/>
                <!-- Rules -->
                <ColumnDefinition Width="300"/>
                <!-- Actions (fixed) -->
            </Grid.ColumnDefinitions>

            <!-- Scope -->
            <Border Grid.Column="0" Style="{StaticResource Card}" Margin="0 10 12 0">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    <Border Style="{StaticResource HeaderBar}">
                        <TextBlock Text="Application Scope" Foreground="White" FontWeight="SemiBold"/>
                    </Border>
                    <StackPanel Grid.Row="1" Margin="10">
                        <RadioButton Content="Entire project"
                                     IsChecked="{Binding IsAllSelected, Mode=TwoWay}"
                                     Command="{Binding ScopeChangedCommand}"
                                     CommandParameter="All"
                                     Margin="0,6,0,0"/>
                        <RadioButton Content="Current selection"
                                     IsChecked="{Binding IsSelectedSelected, Mode=TwoWay}"
                                     Command="{Binding ScopeChangedCommand}"
                                     CommandParameter="Selected"/>
                    </StackPanel>
                </Grid>
            </Border>

            <!-- Sort order -->
            <Border Grid.Column="1" Style="{StaticResource Card}" Margin="0 10 12 0">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    <Border Style="{StaticResource HeaderBar}">
                        <TextBlock Text="Sort Drawing Order" Foreground="White" FontWeight="SemiBold"/>
                    </Border>
                    <StackPanel Grid.Row="1" Margin="12" VerticalAlignment="Top">
                        <StackPanel Margin="0,0,0,8">
                            <TextBlock Text="Prefix" Foreground="#6E6A64" Margin="0,0,0,2"/>
                            <TextBox Style="{StaticResource UnderlineTextBox}" 
                                     Text="{Binding PrefixNumber, UpdateSourceTrigger=PropertyChanged}"/>
                        </StackPanel>
                        <StackPanel>
                            <TextBlock Text="Start Number" Foreground="#6E6A64" Margin="0,0,0,2"/>
                            <TextBox Style="{StaticResource UnderlineTextBox}" 
                                     Text="{Binding StartNumber, UpdateSourceTrigger=PropertyChanged}"/>
                        </StackPanel>
                        <Button Style="{StaticResource CreateFilledButton}" 
                                Content="Sort Order"
                                Command="{Binding ArrangeSheetNumbersCommand}"/>
                    </StackPanel>
                </Grid>
            </Border>

            <!-- Rules -->
            <Border Grid.Column="2" Style="{StaticResource Card}" Margin="0 10 12 0">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <Border Style="{StaticResource HeaderBar}">
                        <TextBlock Text="Automatic Naming Rules" Foreground="White" FontWeight="SemiBold"/>
                    </Border>

                    <!-- Enable shared-size to align child Grid columns -->
                    <Grid Grid.Row="1" Margin="12" Grid.IsSharedSizeScope="True">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <!-- Prefix/Suffix -->
                            <RowDefinition Height="12"/>
                            <RowDefinition Height="Auto"/>
                            <!-- Find/Replace -->
                            <RowDefinition Height="12"/>
                            <RowDefinition Height="Auto"/>
                            <!-- Radio -->
                        </Grid.RowDefinitions>

                        <!-- Row 1: Prefix / Suffix -->
                        <Grid Grid.Row="0">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto" SharedSizeGroup="lbl"/>
                                <ColumnDefinition Width="12"   SharedSizeGroup="gap"/>
                                <ColumnDefinition Width="*"    SharedSizeGroup="fld"/>
                                <ColumnDefinition Width="24"/>
                                <ColumnDefinition Width="Auto" SharedSizeGroup="lbl"/>
                                <ColumnDefinition Width="12"   SharedSizeGroup="gap"/>
                                <ColumnDefinition Width="*"    SharedSizeGroup="fld"/>
                            </Grid.ColumnDefinitions>

                            <TextBlock Grid.Column="0" Text="Add Prefix:" VerticalAlignment="Center"/>
                            <TextBox   Grid.Column="2" Style="{StaticResource UnderlineTextBox}"
                                       Text="{Binding Prefix, UpdateSourceTrigger=PropertyChanged}" MinWidth="140"/>

                            <TextBlock Grid.Column="4" Text="Add Suffix:" VerticalAlignment="Center"/>
                            <TextBox   Grid.Column="6" Style="{StaticResource UnderlineTextBox}"
                                       Text="{Binding Suffix, UpdateSourceTrigger=PropertyChanged}" MinWidth="140"/>
                        </Grid>

                        <!-- Row 3: Find / Replace -->
                        <Grid Grid.Row="2">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto" SharedSizeGroup="lbl"/>
                                <ColumnDefinition Width="12"   SharedSizeGroup="gap"/>
                                <ColumnDefinition Width="*"    SharedSizeGroup="fld"/>
                                <ColumnDefinition Width="24"/>
                                <ColumnDefinition Width="Auto" SharedSizeGroup="lbl"/>
                                <ColumnDefinition Width="12"   SharedSizeGroup="gap"/>
                                <ColumnDefinition Width="*"    SharedSizeGroup="fld"/>
                            </Grid.ColumnDefinitions>

                            <TextBlock Grid.Column="0" Text="Find Value:" VerticalAlignment="Center"/>
                            <TextBox   Grid.Column="2" Style="{StaticResource UnderlineTextBox}"
                                       Text="{Binding Find, UpdateSourceTrigger=PropertyChanged}" MinWidth="140"/>

                            <TextBlock Grid.Column="4" Text="Replace With:" VerticalAlignment="Center"/>
                            <TextBox   Grid.Column="6" Style="{StaticResource UnderlineTextBox}"
                                       Text="{Binding Replace, UpdateSourceTrigger=PropertyChanged}" MinWidth="140"/>
                        </Grid>

                        <!-- Row 5: Radio -->
                        <StackPanel Grid.Row="4" Orientation="Horizontal">
                            <RadioButton Content="Sheet Number" GroupName="RuleTarget"
                                         IsChecked="{Binding ApplyToNumber, Mode=TwoWay}"/>
                            <RadioButton Content="Sheet Name" GroupName="RuleTarget"
                                         IsChecked="{Binding ApplyToName, Mode=TwoWay}" Margin="20,0,0,0"/>
                        </StackPanel>
                    </Grid>
                </Grid>
            </Border>

            <!-- Actions -->
            <StackPanel Grid.Column="3" Margin="0 10 0 0">
                <Border Style="{StaticResource Card}">
                    <StackPanel>
                        <TextBlock Text="Function Keys" FontWeight="SemiBold" Margin="0 0 0 6"/>
                        <Button Style="{StaticResource UpdateFilledButton}" Command="{Binding ApplyRulesCommand}" Content="Apply Rules"/>
                        <Button Style="{StaticResource CreateFilledButton}" Command="{Binding RenameCommand}" Content="Rename"/>
                    </StackPanel>
                </Border>
            </StackPanel>
        </Grid>
    </Grid>
</Window>